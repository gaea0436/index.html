<script>
    // --- 資料區 ---

    // 氣象資料 (模擬 2026 二月預測)
    const weatherDB = {
        "2026-02-03": { temp: "5-11°C", icon: "cloud-sun", tip: "搭機日，洋蔥式穿搭，帶薄圍巾。" },
        "2026-02-04": { temp: "3-9°C", icon: "sun", tip: "戶外行程多，穿著羽絨衣與好走的鞋。" },
        "2026-02-05": { temp: "2-8°C", icon: "snowflake", tip: "微冷，建議戴毛帽與手套保暖。" },
        "2026-02-06": { temp: "4-10°C", icon: "cloud", tip: "市區逛街，穿著舒適保暖即可。" },
        "2026-02-07": { temp: "5-12°C", icon: "sun", tip: "天氣回暖，適合拍照，可穿亮色大衣。" },
        "2026-02-08": { temp: "6-13°C", icon: "plane", tip: "返程日，確認隨身行李輕便。" }
    };

    // 行程資料 (已修正語法錯誤與 Key 格式)
    const itineraryDB = {
        "2026-02-03": [
            { time: "15:35", title: "桃園 T1 起飛 (IT202)", type: "交通", note: "建議在機場先吃午餐。13:30 抵達機場報到。", link: "geo:25.0797,121.2342" },
            { time: "19:35", title: "抵達成田 T2", type: "交通", note: "購買/儲值西瓜卡 (Suica)。", link: "geo:35.7719,140.3929" },
            { time: "20:30", title: "搭乘 Skyliner 往市區", type: "交通", note: "車上可先吃點輕食。車程約 45 分鐘。", link: "" },
            { time: "21:45", title: "入住：四谷京阪飯店", type: "住宿", note: "四谷站步行3分，旁有 LIFE 超市可買水。", link: "https://goo.gl/maps/placeholder" }
        ],
        "2026-02-04": [
            { time: "09:30", title: "上野東照宮", type: "景點", note: "金碧輝煌的江戶建築與牡丹花園。", link: "https://goo.gl/maps/placeholder" },
            { time: "10:30", title: "上野恩賜公園/不忍池", type: "景點", note: "欣賞蓮花池枯景、辯天堂參拜。", link: "https://goo.gl/maps/placeholder" },
            { time: "11:00", title: "午餐：伊豆榮 梅川亭", type: "餐飲", note: "百年鰻魚飯老店，就在公園內。", link: "https://goo.gl/maps/placeholder" },
            { time: "11:30", title: "淺草寺", type: "景點", note: "江戶風情、紅色巨大燈籠，仲見世通吃人形燒。", link: "https://goo.gl/maps/placeholder" },
            { time: "12:30", title: "雷門", type: "景點", note: "購買龜十銅鑼燒（需排隊）。", link: "https://goo.gl/maps/placeholder" },
            { time: "13:00", title: "午餐 (淺草周邊)", type: "餐飲", note: "建議尋找在地特色料理。", link: "" },
            { time: "14:30", title: "隅田川公園 / 遠眺晴空塔", type: "觀光", note: "拍照打卡、享受河岸景觀。", link: "https://goo.gl/maps/placeholder" }
        ],
        "2026-02-05": [
            { time: "09:00", title: "皇居(二重橋/外苑)", type: "園林", note: "必帶護照。護城河、日式回遊庭園。", link: "https://goo.gl/maps/placeholder" },
            { time: "10:00", title: "皇居東御苑", type: "景點", note: "欣賞江戶城遺跡。", link: "https://goo.gl/maps/placeholder" },
            { time: "11:00", title: "午餐：東京車站一番街", type: "餐飲", note: "六厘舍沾麵或根岸牛舌定食 (有單人位)。", link: "https://goo.gl/maps/placeholder" },
            { time: "14:00", title: "東京大神宮", type: "觀光", note: "東京最強結緣神社，預估45分。", link: "https://goo.gl/maps/placeholder" },
            { time: "15:00", title: "秋葉原無線電會館", type: "景點", note: "Yodobashi Camera 6樓找搖曳露營週邊。", link: "https://goo.gl/maps/placeholder" },
            { time: "", title: "K-BOOKS 秋葉原本館", type: "景點", note: "尋找志摩凜公仔現貨。", link: "https://goo.gl/maps/placeholder" },
            { time: "", title: "駿河屋 / らしんばん", type: "景點", note: "二手公仔尋寶。", link: "" },
            { time: "16:30", title: "神田神社", type: "景點", note: "LoveLive聖地，朱紅建築。", link: "https://goo.gl/maps/placeholder" },
            { time: "17:30", title: "晚餐：神田 藪蕎麥", type: "餐飲", note: "百年老店，或吃神保町咖哩。", link: "" },
            { time: "18:00", title: "東京巨蛋", type: "景點", note: "LaQua 購物與戶外拍照。", link: "https://goo.gl/maps/placeholder" }
        ],
        "2026-02-06": [
            { time: "09:00", title: "明治神宮", type: "景點", note: "都市森林漫步，參觀御苑。預估1.5h。", link: "https://goo.gl/maps/placeholder" },
            { time: "10:45", title: "明治神宮棒球場", type: "景點", note: "朝聖棒球聖地。", link: "https://goo.gl/maps/placeholder" },
            { time: "13:00", title: "新宿御苑", type: "景點", note: "《言葉之庭》取景地，極美。預估2h。", link: "https://goo.gl/maps/placeholder" },
            { time: "16:30", title: "思出橫丁", type: "景點", note: "昭和懷舊窄巷、居酒屋街。", link: "https://goo.gl/maps/placeholder" },
            { time: "17:30", title: "Alpen Tokyo", type: "購物", note: "最大級露營用品店。", link: "https://goo.gl/maps/placeholder" },
            { time: "18:30", title: "東京都廳展望室", type: "景點", note: "45樓免費高空看新宿夜景。", link: "https://goo.gl/maps/placeholder" },
            { time: "19:30", title: "晚餐：AFURI 柚子拉麵", type: "餐飲", note: "清爽柚子鹽口味。", link: "" }
        ],
        "2026-02-07": [
            { time: "09:00", title: "退房 & 行李寄送", type: "交通", note: "將行李寄放在澀谷站，換宿至池尻大橋。", link: "" },
            { time: "10:30", title: "東京鐵塔/芝公園", type: "景點", note: "芝公園階梯或停車場出口經典拍攝位。", link: "https://goo.gl/maps/placeholder" },
            { time: "12:30", title: "午餐：炸牛排 Motomura", type: "餐飲", note: "口感軟嫩，記得排隊。", link: "" },
            { time: "14:00", title: "國立新美術館", type: "景點", note: "黑川紀章大作，波浪形玻璃帷幕。", link: "https://goo.gl/maps/placeholder" },
            { time: "15:30", title: "竹下通、表參道", type: "景點", note: "表參道之丘 (安藤忠雄作品)。", link: "https://goo.gl/maps/placeholder" },
            { time: "17:30", title: "澀谷Sky", type: "景點", note: "需預約。日落俯瞰東京全景。", link: "https://goo.gl/maps/placeholder" },
            { time: "", title: "澀谷交叉點", type: "景點", note: "世界最繁忙路口。", link: "https://goo.gl/maps/placeholder" },
            { time: "19:30", title: "晚餐：敘敘苑 (單人窗位)", type: "餐飲", note: "享受最後一晚的東京氛圍。", link: "" },
            { time: "20:30", title: "入住：池尻大橋住宿", type: "住宿", note: "近中目黑，慢活生活感。", link: "https://goo.gl/maps/placeholder" },
            { time: "", title: "備用：中目黑星巴克工坊", type: "餐飲", note: "隈研吾設計，四層樓大型烘焙工房。", link: "https://goo.gl/maps/placeholder" }
        ],
        "2026-02-08": [
            { time: "07:30", title: "前往成田機場T1", type: "交通", note: "預留充足報到時間。", link: "" },
            { time: "09:15", title: "抵達機場報到 (MM623)", type: "交通", note: "樂桃航空報到時間較嚴格。", link: "" },
            { time: "11:15", title: "飛機起飛 (返台)", type: "交通", note: "結束愉快的東京獨旅。", link: "" },
            { time: "14:30", title: "抵達桃園 T1", type: "交通", note: "平安回家。", link: "" }
        ]
    };

    const foodDB = [
        { name: "FamiChiki 炸雞", jp: "ファミチキ", price: "¥240", shop: "FamilyMart", icon: "drumstick-bite" },
        { name: "炸雞君 (辣味/起司)", jp: "からあげクン Red", price: "¥258", shop: "Lawson", icon: "crow" },
        { name: "關東煮 (蘿蔔/半熟蛋)", jp: "おでん (大根/たまご)", price: "¥120", shop: "7-11", icon: "mug-hot" },
        { name: "麻糬口感生乳捲", jp: "もち食感ロール", price: "¥397", shop: "Lawson", icon: "bread-slice" },
        { name: "濃厚蛋黃醬泡芙", jp: "カスタード＆ホイップ", price: "¥150", shop: "7-11", icon: "cookie" }
    ];

    // --- 程式邏輯區 ---

    let currentDate = "2026-02-03";
    const dates = Object.keys(itineraryDB).sort(); // 確保日期排序正確

    // 初始化
    window.onload = function() {
        renderDateNav();
        renderItinerary(currentDate);
        renderWeather(currentDate);
        renderFood();
        loadExpenses(); // 載入儲存的記帳資料
    };

    // 渲染日期導航
    function renderDateNav() {
        const container = document.getElementById('dateNav');
        container.innerHTML = ''; // 清空舊內容
        dates.forEach(date => {
            const dayParts = date.split('-');
            const md = `${parseInt(dayParts[1])}/${parseInt(dayParts[2])}`; // 轉成 2/3 格式
            
            const el = document.createElement('div');
            el.className = `date-chip ${date === currentDate ? 'active' : ''}`;
            el.innerText = md;
            el.onclick = () => selectDate(date);
            container.appendChild(el);
        });
    }

    // 選擇日期
    function selectDate(date) {
        currentDate = date;
        // 更新 UI 樣式
        document.querySelectorAll('.date-chip').forEach(el => {
            el.classList.remove('active');
            const dayParts = date.split('-');
            const md = `${parseInt(dayParts[1])}/${parseInt(dayParts[2])}`;
            if(el.innerText === md) el.classList.add('active');
        });
        
        renderItinerary(date);
        renderWeather(date);
    }

    // 渲染行程
    function renderItinerary(date) {
        const list = document.getElementById('itineraryList');
        const items = itineraryDB[date] || [];
        list.innerHTML = "";
        
        if(items.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:20px; color:#999;">本日無預定行程</div>`;
            return;
        }

        items.forEach(item => {
            const html = `
            <div class="timeline-item">
                <div class="time-col">${item.time}</div>
                <div class="content-col">
                    <span class="tag ${item.type}">${item.type}</span>
                    <h3>${item.title}</h3>
                    <div class="note">${item.note}</div>
                    ${item.link ? `<a href="${item.link}" target="_blank" class="map-btn"><i class="fas fa-location-dot"></i> 導航</a>` : ''}
                </div>
            </div>`;
            list.innerHTML += html;
        });
    }

    // 渲染氣象
    function renderWeather(date) {
        const data = weatherDB[date];
        if (data) {
            const dayParts = date.split('-');
            // 簡易計算星期 (僅適用於已知區間)
            const weekDays = ["日", "一", "二", "三", "四", "五", "六"];
            const dt = new Date(date);
            const weekDay = weekDays[dt.getDay()];
            
            document.getElementById('currentDateDisplay').innerText = `${parseInt(dayParts[1])}月${parseInt(dayParts[2])}日 (${weekDay})`;
            document.getElementById('weatherTemp').innerText = data.temp;
            document.getElementById('weatherTip').innerHTML = `<i class="fas fa-tshirt"></i> <span>${data.tip}</span>`;
        }
    }

    // 渲染美食
    function renderFood() {
        const list = document.getElementById('foodList');
        // 避免重複渲染
        if(list.innerHTML.trim() !== "") return;
        
        foodDB.forEach(item => {
            list.innerHTML += `
            <div class="food-card">
                <div class="food-img-placeholder"><i class="fas fa-${item.icon}"></i></div>
                <div class="food-info">
                    <div class="food-name">${item.name}</div>
                    <div class="food-jp">${item.jp}</div>
                    <div class="food-price">${item.price} (${item.shop})</div>
                </div>
            </div>`;
        });
    }

    // 頁面切換
    function switchPage(pageId, navEl) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        navEl.classList.add('active');
        
        // 切換頁面時自動捲動到頂部
        window.scrollTo(0,0);
    }

    // --- 記帳功能 (含 LocalStorage 儲存) ---
    
    let total = 0;
    const STORAGE_KEY = 'tokyo_trip_expenses';

    function addExpense() {
        const nameInput = document.getElementById('expenseName');
        const amountInput = document.getElementById('expenseAmount');
        const name = nameInput.value;
        const amount = parseInt(amountInput.value);

        if(!name || isNaN(amount)) {
            alert("請輸入項目名稱與正確金額");
            return;
        }

        const expense = { name, amount, id: Date.now() };
        saveExpenseToStorage(expense);
        renderExpenseItem(expense);
        updateTotal(amount);

        // 清空輸入
        nameInput.value = '';
        amountInput.value = '';
    }

    function updateTotal(amount) {
        total += amount;
        document.getElementById('totalExpense').innerText = `¥${total.toLocaleString()}`;
    }

    function renderExpenseItem(item) {
        const list = document.getElementById('expenseList');
        const li = document.createElement('li');
        li.style.cssText = "display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px dashed #eee; padding-bottom:5px;";
        li.innerHTML = `<span>${item.name}</span> <span>¥${item.amount.toLocaleString()}</span>`;
        list.appendChild(li);
    }
    
    // 儲存到瀏覽器
    function saveExpenseToStorage(expense) {
        const expenses = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        expenses.push(expense);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
    }

    // 讀取舊資料
    function loadExpenses() {
        const expenses = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        expenses.forEach(item => {
            renderExpenseItem(item);
            updateTotal(item.amount);
        });
    }

</script>
